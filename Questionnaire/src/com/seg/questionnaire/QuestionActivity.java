package com.seg.questionnaire;

import android.app.Activity;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.ProgressBar;
import android.widget.RelativeLayout;
import android.widget.TextView;
import android.widget.Toast;

import com.seg.questionnaire.backend.AnswersFactory;
import com.seg.questionnaire.backend.Questionnaire;
import com.seg.questionnaire.backend.QuestionnaireFactory;
import com.seg.questionnaire.backend.json.JSONParser;
import com.seg.questionnaire.backend.question.Question;

/**
 * Class responsible for displaying all questions from a 
 * questionnaire and handling the whole questionnaire.
 * 
 * @author Marek Matejka
 *
 */
public class QuestionActivity extends Activity 
{	
	/**
	 * Defines the current question
	 */
	private int currentQuestion = 0;
		
	/**
	 * Current questionnaire being used.
	 */
	private Questionnaire ques;
	
	/* (non-Javadoc)
	 * @see android.app.Activity#onCreate(android.os.Bundle)
	 */
	@Override
	protected void onCreate(Bundle savedInstanceState) 
	{
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_question);
		
		//initialize questionnaire
		ques = QuestionnaireFactory.creatQuestionnaire(JSONParser.parse(this));
		//ques.loadDummy();
				
		//load first question
		loadQuestion(ques.getQuestion(currentQuestion));
		
		JSONParser.parse(this);	
	}
	
	/**
	 * Responds to click event on 'Next' button.
	 * 
	 * @param v View on which the event happened.
	 */
	public void onClick(View v)
	{
		//take current question and answer
		Question q = ques.getQuestion(currentQuestion);
		Object a = q.getAnswer();
		
		if (a == null) //if no answer
			Toast.makeText(this, "Give me your answer first!", Toast.LENGTH_SHORT).show(); //ask for it
		else
		{
			if (q.hasDependentQuestions(a.toString())) //if there are some dependent questions for a given answer
				ques.addQuestions(q.getDependentQuestions(a.toString()), currentQuestion); //add them to the questionnaire
								
			Toast.makeText(this, "answer = '"+q.getAnswer().toString()+"'", Toast.LENGTH_SHORT).show(); //show the answer
			
			currentQuestion = (currentQuestion+1)%ques.getNumberOfQuestions(); //increase the current question and keep looping
			
			if (currentQuestion == 0) //if first question in new loop
			{
				Log.e("DEBUG", JSONParser.toJSON(AnswersFactory.createJSON(ques))); //create and print AnswersJSON
				ques.deleteQuestionnaire();
				ques = QuestionnaireFactory.creatQuestionnaire(JSONParser.parse(this)); //create new questionnaire
				//ques.loadDummy();
			}
			
			loadQuestion(ques.getQuestion(currentQuestion)); //load next question
		}
	}
	
	/**
	 * Loads a given question and displays it to the user.
	 * 
	 * @param q Question to be loaded and displayed.
	 */
	private void loadQuestion(Question q)
	{	
		updateProgress();
		
		//find the RelativeLayout
		RelativeLayout answer = (RelativeLayout)findViewById(R.id.answer);
		
		//make it empty
		answer.removeAllViews(); 
		
		//add the View generated by the Question
		answer.addView(q.getView(this));
		
		//find the question TextView and set it with question text for the question
		TextView question = (TextView)findViewById(R.id.question);
		question.setText(q.getQuestion());
	}
	
	/**
	 * Updates progress visually to the user.
	 */
	private void updateProgress()
	{
		//find a TextView and set it with current values
		TextView outOf = (TextView) findViewById(R.id.outOf);
		outOf.setText(""+(currentQuestion+1)+"/"+ques.getNumberOfQuestions());
		
		//find a ProgressBar and set it to current value
		ProgressBar p = (ProgressBar) findViewById(R.id.progressBar1);
		p.setMax(ques.getNumberOfQuestions());
		p.setProgress(currentQuestion+1);
	}
}
